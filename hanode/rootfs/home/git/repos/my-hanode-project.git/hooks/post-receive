#!/bin/bash

# Log the hook execution
echo "Post-receive hook triggered at $(date)" >> /tmp/git-hook.log

# Get the work tree directory
GIT_WORK_TREE="/var/www/hanode-app"
mkdir -p "$GIT_WORK_TREE"

# Read the ref updates from stdin
while read oldrev newrev refname; do
  branch=$(echo "$refname" | sed -e 's,.*/\(.*\),\1,')
  echo "Received push to branch: $branch (old: $oldrev new: $newrev)" >> /tmp/git-hook.log

  # Only deploy if master or main branch was pushed
  if [ "$branch" = "master" ] || [ "$branch" = "main" ] || [ "$branch" = "release" ]; then
    echo "Deploying $branch branch to $GIT_WORK_TREE" >> /tmp/git-hook.log
    git --work-tree="$GIT_WORK_TREE" --git-dir=/home/git/repos/my-hanode-project.git checkout -f "$branch"

    echo "Updating server info" >> /tmp/git-hook.log
    git update-server-info

    echo "Deployment completed successfully" >> /tmp/git-hook.log
  else
    echo "Not deploying branch $branch" >> /tmp/git-hook.log
  fi
done

# Ensure the info refs are updated for git-http-backend
cd /home/git/repos/my-hanode-project.git
git update-server-info